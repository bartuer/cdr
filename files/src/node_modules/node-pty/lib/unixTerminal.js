"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},e(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var net=require("net"),terminal_1=require("./terminal"),utils_1=require("./utils"),pty=utils_1.loadNative("pty"),DEFAULT_FILE="sh",DEFAULT_NAME="xterm",DESTROY_SOCKET_TIMEOUT_MS=200,UnixTerminal=function(e){function t(t,n,r){var i=e.call(this,r)||this;if(typeof n=="string")throw new Error("args as a string is not supported on unix.");n=n||[],t=t||DEFAULT_FILE,r=r||{},r.env=r.env||process.env;var s=r.cols||terminal_1.DEFAULT_COLS,o=r.rows||terminal_1.DEFAULT_ROWS,u=r.uid||-1,a=r.gid||-1,f=utils_1.assign({},r.env);r.env===process.env&&i._sanitizeEnv(f);var l=r.cwd||process.cwd(),c=r.name||f.TERM||DEFAULT_NAME;f.TERM=c;var h=i._parseEnv(f),p=r.encoding===undefined?"utf8":r.encoding,d=function(e,t){if(!i._emittedClose){if(i._boundClose)return;i._boundClose=!0;var n=setTimeout(function(){n=null,i._socket.destroy()},DESTROY_SOCKET_TIMEOUT_MS);i.once("close",function(){n!==null&&clearTimeout(n),i.emit("exit",e,t)});return}i.emit("exit",e,t)},v=pty.fork(t,n,h,l,s,o,u,a,p==="utf8",d);return i._socket=new PipeSocket(v.fd),p!==null&&i._socket.setEncoding(p),i._socket.on("error",function(e){if(e.code&&~e.code.indexOf("EAGAIN"))return;i._close(),i._emittedClose||(i._emittedClose=!0,i.emit("close"));if(e.code)if(~e.code.indexOf("errno 5")||~e.code.indexOf("EIO"))return;if(i.listeners("error").length<2)throw e}),i._pid=v.pid,i._fd=v.fd,i._pty=v.pty,i._file=t,i._name=c,i._readable=!0,i._writable=!0,i._socket.on("close",function(){if(i._emittedClose)return;i._emittedClose=!0,i._close(),i.emit("close")}),i}return __extends(t,e),Object.defineProperty(t.prototype,"master",{get:function(){return this._master},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"slave",{get:function(){return this._slave},enumerable:!0,configurable:!0}),t.open=function(e){var n=Object.create(t.prototype);e=e||{},arguments.length>1&&(e={cols:arguments[1],rows:arguments[2]});var r=e.cols||terminal_1.DEFAULT_COLS,i=e.rows||terminal_1.DEFAULT_ROWS,s=e.encoding?"utf8":e.encoding,o=pty.open(r,i);return n._master=new PipeSocket(o.master),n._master.setEncoding(s),n._master.resume(),n._slave=new PipeSocket(o.slave),n._slave.setEncoding(s),n._slave.resume(),n._socket=n._master,n._pid=null,n._fd=o.master,n._pty=o.pty,n._file=process.argv[0]||"node",n._name=process.env.TERM||"",n._readable=!0,n._writable=!0,n._socket.on("error",function(e){n._close();if(n.listeners("error").length<2)throw e}),n._socket.on("close",function(){n._close()}),n},t.prototype.write=function(e){this._socket.write(e)},t.prototype.destroy=function(){var e=this;this._close(),this._socket.once("close",function(){e.kill("SIGHUP")}),this._socket.destroy()},t.prototype.kill=function(e){try{process.kill(this.pid,e||"SIGHUP")}catch(t){}},Object.defineProperty(t.prototype,"process",{get:function(){return pty.process(this._fd,this._pty)||this._file},enumerable:!0,configurable:!0}),t.prototype.resize=function(e,t){pty.resize(this._fd,e,t)},t.prototype._sanitizeEnv=function(e){delete e.TMUX,delete e.TMUX_PANE,delete e.STY,delete e.WINDOW,delete e.WINDOWID,delete e.TERMCAP,delete e.COLUMNS,delete e.LINES},t}(terminal_1.Terminal);exports.UnixTerminal=UnixTerminal;var PipeSocket=function(e){function t(t){var n=this,r=process.binding("tty_wrap"),i=r.guessHandleType;return r.guessHandleType=function(){return"PIPE"},n=e.call(this,{fd:t})||this,r.guessHandleType=i,n}return __extends(t,e),t}(net.Socket);